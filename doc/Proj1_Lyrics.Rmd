---
title: "Proj1 ADS"
author: "Tushar Ponkshe"
date: 'Due: 9/18/2019'
output:
  html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, message=FALSE, warning=FALSE,echo=FALSE}
packages.used=c("tm", "tidytext","tidyverse","DT","wordcloud","scales","gridExtra","ngram","igraph","ggraph","rsconnect")

# check packages that need to be installed.
packages.needed=setdiff(packages.used, 
                        intersect(installed.packages()[,1], 
                                  packages.used))
# install additional packages
if(length(packages.needed)>0){
  install.packages(packages.needed, dependencies = TRUE)
}

# load packages
#most of the libraries needed
library(dplyr) #data manipulation
library(textdata)
library(ggplot2) #visualizations
library(gridExtra) #viewing multiple plots together
library(tidytext) #text mining
library(wordcloud2) #creative visualizations
library(knitr) # for dynamic reporting
library(kableExtra) # create a nicely formated HTML table
library(formattable) # for the color_tile function
library(stringr)
library(tm)
library(tidytext)
library(tidyverse)
library(DT)
library(wordcloud)
library(scales)
library(cowplot)
```

```{r, message=FALSE, warning=FALSE,echo=FALSE}
#loading processed lyrics data
load('../output/processed_lyrics.RData')
artists = read_csv('../data/artists.csv')
names(artists) = c("artist", "intro", "formed", "members", "origin")
leftJoinDf = dt_lyrics %>%
  left_join(artists, by = "artist")
```

## Part 1 - EDA

```{r,warning=FALSE, message=FALSE,echo=FALSE}
# # observations and columns
dim(leftJoinDf)
```

One of the target questions is to look for song trends across time, and the dataset contains individual release years - we can create buckets and group the years into decades.

```{r,warning=FALSE, message=FALSE,echo=FALSE}

leftJoinDf <- leftJoinDf %>%
  mutate(decade = 
           ifelse(year %in% 1970:1980, "1970s",
           ifelse(year %in% 1980:1989, "1980s", 
           ifelse(year %in% 1990:1999, "1990s", 
           ifelse(year %in% 2000:2009, "2000s", 
           ifelse(year %in% 2010:2020, "2010s", 
                  "NA"))))))
```

Defining theme to use throughout the data story

```{r,warning=FALSE, message=FALSE,echo=FALSE}
theme_lyrics <- function() 
{
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_blank(), 
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none")
}
```



```{r,warning=FALSE, message=FALSE,echo=FALSE}
library(magrittr)
leftJoinDf %>%
  filter(decade != "NA") %>%
  dplyr::group_by(decade, genre) %>%
  dplyr::summarise(number_of_songs = n()) %>%
  ggplot() + 
  geom_bar(aes(x = decade, y = number_of_songs, 
               fill = genre), stat = "identity")  +
  theme(plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        panel.grid.minor = element_blank()) +
  ggtitle("Released Songs") +
  labs(x = NULL, y = "Song Count")
```

The plot above shows that the most active decade was 2000s, with Rock being the most popular genre.


$~$

Songs with most words (showing only top 10), grouped by artists.  

```{r,warning=FALSE, message=FALSE,echo=FALSE}
library(magrittr)
full_word_count <- leftJoinDf %>%
  unnest_tokens(word, stemmedwords) %>%
  dplyr::group_by(song, artist, genre) %>%
  dplyr::summarise(num_words = n()) %>%
  arrange(desc(num_words)) 

full_word_count[1:10,] %>%
  ungroup(num_words, song)
```


```{r,warning=FALSE, message=FALSE,echo=FALSE}
full_word_count %>%
  ggplot() +
    geom_histogram(aes(x = num_words, fill = genre )) +
    ylab("Song Count") + 
    xlab("Word Count per Song") +
    ggtitle("Word Count Distribution") +
    theme(plot.title = element_text(hjust = 0.5),
          legend.title = element_blank(),
          panel.grid.minor.y = element_blank())
```

The histogram is very skewed to the right, with most songs containing fewer than 500 words.


$~$

**What are the most frequently used words?**
```{r,warning=FALSE, message=FALSE,echo=FALSE}
undesirable_words = c("lot", "today", "months", "month", "wanna", "wouldnt", "wasnt", "ha", "na", "ooh", "da",
        "gonna", "im", "dont", "aint", "wont", "yeah", "la", "oi", "nigga", "fuck",
          "hey", "year", "years", "last", "past", "feel")
song_words_filtered = leftJoinDf %>%
  unnest_tokens(word, stemmedwords) %>%
  anti_join(stop_words) %>%
  distinct() %>%
  filter(!word %in% undesirable_words) %>%
  filter(nchar(word) > 3)

song_words_filtered %>%
  dplyr::count(word, sort = TRUE) %>%
  top_n(10) %>%
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot() +
    geom_col(aes(word, n), fill = "#0072B2") +
    theme(legend.position = "none", 
          plot.title = element_text(hjust = 0.5),
          panel.grid.major = element_blank()) +
    xlab("") + 
    ylab("Song Count") +
    ggtitle("Top 10 Most Frequently Used Words") +
    coord_flip()
```

$~$

**Word Cloud #1: Most frequently used words in lyrics data**

```{r,warning=FALSE, message=FALSE,echo=FALSE}
word_counts <- song_words_filtered %>%
  dplyr::count(word, sort = TRUE)

set.seed(1234)
wordcloud(words = word_counts$word, freq = word_counts$n, min.freq = 1,
          max.words=200, random.order=FALSE, rot.per=0.35, 
          colors=brewer.pal(9, "Dark2"))
```


```{r,warning=FALSE, message=FALSE,echo=FALSE}
popular_words <- song_words_filtered %>% 
  group_by(genre) %>%
  dplyr::count(word, genre, sort = TRUE) %>%
  slice(seq_len(8)) %>%
  ungroup() %>%
  arrange(genre,n) %>%
  dplyr::mutate(row = row_number()) 

popular_words %>%
  ggplot(aes(row, n, fill = genre)) +
    geom_col(show.legend = NULL) +
    labs(x = NULL, y = "Song Count") +
    ggtitle("Popular Words by Genre") + 
    theme_lyrics() +  
    facet_wrap(~genre, scales = "free") +
    scale_x_continuous(  # This handles replacement of row 
      breaks = popular_words$row, # notice need to reuse data frame
      labels = popular_words$word) +
    coord_flip()
```

The top words across the genres are very similar.


$~$

**Popular words across decades**


```{r, message=FALSE, warning=FALSE,echo=FALSE}
timeless_words <- song_words_filtered %>% 
  filter(decade != 'NA') %>%
  group_by(decade) %>%
  dplyr::count(word, decade, sort = TRUE) %>%
  slice(seq_len(8)) %>%
  ungroup() %>%
  arrange(decade,n) %>%
  dplyr::mutate(row = row_number()) 

timeless_words %>%
  ggplot(aes(row, n, fill = decade)) +
    geom_col() +
    labs(x = NULL, y = "Song Count") +
    ggtitle("Top words across decades") + 
    theme_lyrics() +  
    facet_wrap(~decade, scales = "free", ncol = 5) +
    scale_x_continuous(  # This handles replacement of row 
      breaks = timeless_words$row, # notice need to reuse data frame
      labels = timeless_words$word) +
    coord_flip()
```

Again, most top words were common across decades, with order slightly changed.

$~$

**Word Length**

We can also see length of individual words used in songs

```{r,warning=FALSE, message=FALSE,echo=FALSE}
word_lengths <- leftJoinDf %>%
  unnest_tokens(word, stemmedwords) %>%
  group_by(song,decade) %>%
  distinct() %>%
  filter(!word %in% undesirable_words) %>%
  mutate(word_length = nchar(word)) 

word_lengths %>%
  dplyr::count(word_length, sort = TRUE) %>%
  ggplot(aes(word_length), 
         binwidth = 10) + 
    geom_histogram(aes(fill = ..count..),
                   breaks = seq(1,25, by = 2), 
                   show.legend = FALSE) + 
    xlab("Word Length") + 
    ylab("Word Count") +
    ggtitle("Word Length Distribution") +
    theme(plot.title = element_text(hjust = 0.5),
          panel.grid.minor = element_blank())
```

We observe that the histogram is skewed to the right, meaning that most words are less than 15 letters, which makes sense because longer words are not very common and are very hard to rhyme. 

It's interesting to see what these long words are through a wordcloud -->

**Word Cloud #2: What are these really long words?**

```{r,warning=FALSE, message=FALSE,echo=FALSE}
wc <- word_lengths %>%
  ungroup() %>%
  dplyr::select(word, word_length) %>%
  distinct() %>%
  arrange(desc(word_length))

wordcloud2(wc[1:100, ], 
           size = .25,
           minSize = .0005,
           ellipticity = .3, 
           rotateRatio = 1, 
           fontWeight = "bold")
```

Most of these words contain repeated letters; these words may have been used for mimicking tune and rythm and not so much for conveying meaning.

$~$

## Part 2 - Sentiment Analysis and Topic Modeling with NLP

**Sentiment Score**
```{r,warning=FALSE, message=FALSE,echo=FALSE}
tidy_reviews <- leftJoinDf %>% unnest_tokens(word, stemmedwords)
tidy_reviews <- tidy_reviews %>% 
  group_by(id) %>% 
  dplyr::mutate(position_in_review_0 = 1:n())
tidy_reviews <- tidy_reviews %>% 
  group_by(id) %>% 
  dplyr::mutate(position_in_review_0 = 1:n())
cleaned_reviews <- tidy_reviews %>% 
  arrange(id, position_in_review_0)
cleaned_reviews <- cleaned_reviews %>% 
  group_by(id) %>% 
  dplyr::mutate(position_in_review = 1:n())  %>% 
  dplyr::select(-position_in_review_0)
cleaned_reviews <- cleaned_reviews %>% 
  group_by(id) %>%
  dplyr::mutate(wordcount_review = n(), 
                percentage_in_review = round(position_in_review/wordcount_review,2))

```


**Word Cloud #3 - top words grouped by emotions**

```{r,warning=FALSE, message=FALSE,echo=FALSE}
library(reshape2)
library(wordcloud)
cleaned_reviews %>%
  inner_join(get_sentiments("nrc"), by = "word") %>% 
  dplyr::count(word, sentiment, sort = TRUE) %>% 
  acast(word ~ sentiment, value.var = "n", fill = 0, fun.aggregate = length) %>% 
  comparison.cloud(max.words = 200, title.size = 0.5, scale=c(0.5,1))
```


```{r,warning=FALSE, message=FALSE,echo=FALSE}
nrc_joy <- get_sentiments("nrc") %>% 
  filter(sentiment == "joy")

cleaned_reviews %>%
  inner_join(nrc_joy) %>%
  dplyr::count(word, sort = TRUE)

bing_word_counts <- cleaned_reviews %>%
  inner_join(get_sentiments("bing")) %>%
  dplyr::count(word, sentiment, sort = TRUE) %>%
  ungroup()

bing_word_counts
```


**Term Frequency by Genre - TF**

```{r,warning=FALSE, message=FALSE,echo=FALSE}
lyrics_words <- leftJoinDf %>%
  filter(genre != "Other", genre != "Not Available") %>%
  unnest_tokens(word, stemmedwords) %>%
  dplyr::count(genre, word, sort = TRUE)

total_words <- lyrics_words %>% 
  group_by(genre) %>% 
  dplyr::summarize(total = sum(n))

lyrics_words <- left_join(lyrics_words, total_words)

lyrics_words

ggplot(lyrics_words, aes(n/total, fill = genre)) +
  geom_histogram(show.legend = FALSE) +
  xlim(NA, 0.0009) +
  labs(title = "Frequency distribution") +
  facet_wrap(~genre, ncol = 3, scales = "free_y")
```


**Highest tf-idf words songs, grouped by genre**

```{r,warning=FALSE, message=FALSE,echo=FALSE}
lyrics_words <- lyrics_words %>%
  bind_tf_idf(word, genre, n)

lyrics_words %>%
  arrange(desc(tf_idf)) %>%
  dplyr::mutate(word = factor(word, levels = rev(unique(word)))) %>% 
  group_by(genre) %>% 
  top_n(10) %>% 
  ungroup() %>%
  ggplot(aes(word, tf_idf, fill = genre)) +
  geom_col(show.legend = FALSE) +
  labs(x = NULL, y = "tf-idf") +
  theme_lyrics()+
  facet_wrap(~genre, scales = "free") +
  coord_flip()
```